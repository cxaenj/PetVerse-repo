<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetVerse Storage Bucket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .test-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }

        .test-card h3::before {
            content: "üóÇÔ∏è";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .bucket-status {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .bucket-status.found {
            background: #d4edda;
            color: #155724;
        }

        .bucket-status.missing {
            background: #f8d7da;
            color: #721c24;
        }

        .bucket-status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .upload-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
        }

        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #0056b3;
        }

        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #1976d2;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #007bff;
        }

        .upload-text {
            font-size: 1.1em;
            color: #495057;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9em;
            color: #6c757d;
        }

        .bucket-select {
            margin: 20px 0;
            text-align: center;
        }

        .bucket-select select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            min-width: 200px;
        }

        .upload-progress {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-section {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .result-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .result-item.success {
            background: #d4edda;
            color: #155724;
        }

        .result-item.error {
            background: #f8d7da;
            color: #721c24;
        }

        .result-item.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.success {
            background: #28a745;
        }

        .status-indicator.error {
            background: #dc3545;
        }

        .status-indicator.loading {
            background: #ffc107;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .log-section {
            margin-top: 30px;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-section h3 {
            color: #00ff00;
            margin-bottom: 15px;
        }

        .log-entry {
            margin: 5px 0;
            line-height: 1.4;
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry.success {
            color: #51cf66;
        }

        .log-entry.info {
            color: #74c0fc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÇÔ∏è PetVerse Storage Test</h1>
            <p>Test and verify Supabase storage bucket functionality</p>
        </div>

        <!-- Bucket Status Grid -->
        <div class="test-grid" id="bucketGrid">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- File Upload Section -->
        <div class="upload-section">
            <h3>üìÅ File Upload Test</h3>
            
            <div class="bucket-select">
                <label for="bucketSelect">Choose bucket for upload test:</label>
                <select id="bucketSelect">
                    <option value="pet-photos">Pet Photos</option>
                    <option value="medical-records">Medical Records</option>
                    <option value="product-images">Product Images</option>
                    <option value="user-avatars">User Avatars</option>
                    <option value="documents">Documents</option>
                </select>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Click here or drag & drop files to test upload</div>
                <div class="upload-hint">Supports images, documents, and other files</div>
                <input type="file" id="fileInput" class="file-input" multiple>
            </div>

            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText">Uploading...</div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="runStorageTests()">üß™ Run Full Storage Tests</button>
                <button class="btn" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <h3>üìä Test Results</h3>
            <div id="resultsContainer">
                <div class="result-item info">
                    <span class="status-indicator loading"></span>
                    Ready to test storage functionality
                </div>
            </div>
        </div>

        <!-- Console Log Section -->
        <div class="log-section">
            <h3>üñ•Ô∏è Console Log</h3>
            <div id="logContainer">
                <div class="log-entry info">Storage test page loaded - Ready to begin testing</div>
            </div>
        </div>
    </div>

    <script src="../../config/supabase.js"></script>
    <script>
        // Storage test configuration
        const requiredBuckets = [
            { name: 'pet-photos', description: 'Pet Photos & Images' },
            { name: 'medical-records', description: 'Medical Records & Health Documents' },
            { name: 'product-images', description: 'Product Images & Catalog' },
            { name: 'user-avatars', description: 'User Profile Pictures' },
            { name: 'documents', description: 'General Documents & Files' }
        ];

        let testResults = {
            bucketsExist: false,
            uploadWorks: false,
            downloadWorks: false,
            deleteWorks: false
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupUploadArea();
            checkBucketStatus();
            logMessage('info', 'Initializing storage tests...');
        });

        // Setup drag and drop upload area
        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            uploadFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            uploadFiles(files);
        }

        // Check bucket status
        async function checkBucketStatus() {
            logMessage('info', 'Checking storage bucket status...');
            const grid = document.getElementById('bucketGrid');
            grid.innerHTML = '';

            if (!window.supabaseClient) {
                logMessage('error', 'Supabase client not initialized');
                return;
            }

            try {
                const { data: buckets, error } = await window.supabaseClient.storage.listBuckets();
                
                if (error) {
                    logMessage('error', `Failed to list buckets: ${error.message}`);
                    return;
                }

                const existingBuckets = buckets.map(b => b.name);
                let foundCount = 0;

                requiredBuckets.forEach(bucket => {
                    const exists = existingBuckets.includes(bucket.name);
                    if (exists) foundCount++;

                    const card = createBucketCard(bucket, exists);
                    grid.appendChild(card);
                });

                testResults.bucketsExist = foundCount === requiredBuckets.length;
                
                addResult(testResults.bucketsExist ? 'success' : 'error', 
                    `Storage Buckets: ${foundCount}/${requiredBuckets.length} found`);
                
                logMessage(testResults.bucketsExist ? 'success' : 'error', 
                    `Bucket check complete: ${foundCount}/${requiredBuckets.length} buckets found`);

            } catch (error) {
                logMessage('error', `Bucket check failed: ${error.message}`);
                addResult('error', 'Failed to check storage buckets');
            }
        }

        function createBucketCard(bucket, exists) {
            const card = document.createElement('div');
            card.className = 'test-card';
            
            card.innerHTML = `
                <h3>${bucket.description}</h3>
                <div class="bucket-status ${exists ? 'found' : 'missing'}">
                    <span class="status-indicator ${exists ? 'success' : 'error'}"></span>
                    <strong>${bucket.name}</strong> - ${exists ? 'Found' : 'Missing'}
                </div>
                <small style="color: #6c757d;">Bucket: ${bucket.name}</small>
            `;
            
            return card;
        }

        // Upload files
        async function uploadFiles(files) {
            if (files.length === 0) return;

            const selectedBucket = document.getElementById('bucketSelect').value;
            const progressContainer = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressContainer.style.display = 'block';
            logMessage('info', `Starting upload of ${files.length} file(s) to ${selectedBucket}`);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i / files.length) * 100).toFixed(0);
                
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `Uploading ${file.name} (${i + 1}/${files.length})...`;

                try {
                    const fileName = `test/${Date.now()}-${file.name}`;
                    const { data, error } = await window.supabaseClient.storage
                        .from(selectedBucket)
                        .upload(fileName, file);

                    if (error) {
                        logMessage('error', `Upload failed for ${file.name}: ${error.message}`);
                        addResult('error', `Upload failed: ${file.name} - ${error.message}`);
                        
                        if (error.message.includes('RLS')) {
                            addResult('info', 'Upload blocked by Row Level Security (expected in production)');
                        }
                    } else {
                        logMessage('success', `Upload successful: ${file.name}`);
                        addResult('success', `Upload successful: ${file.name}`);
                        testResults.uploadWorks = true;

                        // Test download/public URL
                        await testFileDownload(selectedBucket, fileName, file.name);
                    }
                } catch (error) {
                    logMessage('error', `Upload error for ${file.name}: ${error.message}`);
                    addResult('error', `Upload error: ${file.name}`);
                }
            }

            progressFill.style.width = '100%';
            progressText.textContent = 'Upload complete!';
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 2000);
        }

        // Test file download
        async function testFileDownload(bucket, fileName, originalName) {
            try {
                logMessage('info', `Testing download for ${originalName}`);
                
                const { data } = window.supabaseClient.storage
                    .from(bucket)
                    .getPublicUrl(fileName);

                if (data && data.publicUrl) {
                    logMessage('success', `Public URL generated: ${originalName}`);
                    addResult('success', `Public URL generated: ${originalName}`);
                    testResults.downloadWorks = true;

                    // Test file deletion
                    await testFileDelete(bucket, fileName, originalName);
                } else {
                    logMessage('error', `Failed to generate public URL: ${originalName}`);
                    addResult('error', `Public URL generation failed: ${originalName}`);
                }
            } catch (error) {
                logMessage('error', `Download test error: ${error.message}`);
                addResult('error', `Download test failed: ${originalName}`);
            }
        }

        // Test file deletion
        async function testFileDelete(bucket, fileName, originalName) {
            try {
                logMessage('info', `Testing deletion for ${originalName}`);
                
                const { error } = await window.supabaseClient.storage
                    .from(bucket)
                    .remove([fileName]);

                if (!error) {
                    logMessage('success', `File deleted successfully: ${originalName}`);
                    addResult('success', `File deleted: ${originalName}`);
                    testResults.deleteWorks = true;
                } else {
                    logMessage('error', `Delete failed for ${originalName}: ${error.message}`);
                    addResult('error', `Delete failed: ${originalName} - ${error.message}`);
                }
            } catch (error) {
                logMessage('error', `Delete test error: ${error.message}`);
                addResult('error', `Delete test failed: ${originalName}`);
            }
        }

        // Run comprehensive storage tests
        async function runStorageTests() {
            logMessage('info', 'üß™ Running comprehensive storage tests...');
            addResult('info', 'Starting comprehensive storage tests...');

            // Reset test results
            testResults = {
                bucketsExist: false,
                uploadWorks: false,
                downloadWorks: false,
                deleteWorks: false
            };

            // Test 1: Check buckets
            await checkBucketStatus();

            // Test 2: Create a test file and upload
            const testFile = new Blob(['PetVerse storage test content'], { type: 'text/plain' });
            const testFileName = `test/automated-test-${Date.now()}.txt`;

            try {
                logMessage('info', 'Testing automated file upload...');
                const { data, error } = await window.supabaseClient.storage
                    .from('documents')
                    .upload(testFileName, testFile);

                if (!error) {
                    logMessage('success', 'Automated upload successful');
                    addResult('success', 'Automated upload test passed');
                    testResults.uploadWorks = true;

                    // Test download
                    await testFileDownload('documents', testFileName, 'automated-test.txt');
                } else {
                    logMessage('error', `Automated upload failed: ${error.message}`);
                    addResult('error', `Automated upload failed: ${error.message}`);
                }
            } catch (error) {
                logMessage('error', `Automated test error: ${error.message}`);
                addResult('error', `Automated test failed: ${error.message}`);
            }

            // Display final results
            const passedTests = Object.values(testResults).filter(result => result).length;
            const totalTests = Object.values(testResults).length;
            
            logMessage('info', `üèÅ Storage tests complete: ${passedTests}/${totalTests} passed`);
            addResult(passedTests === totalTests ? 'success' : 'error', 
                `Storage Tests Complete: ${passedTests}/${totalTests} passed`);
        }

        // Helper functions
        function addResult(type, message) {
            const container = document.getElementById('resultsContainer');
            const item = document.createElement('div');
            item.className = `result-item ${type}`;
            item.innerHTML = `
                <span class="status-indicator ${type}"></span>
                ${message}
            `;
            container.appendChild(item);
        }

        function logMessage(type, message) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearResults() {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="result-item info">
                    <span class="status-indicator loading"></span>
                    Results cleared - Ready for new tests
                </div>
            `;
            document.getElementById('logContainer').innerHTML = `
                <div class="log-entry info">Console cleared - Ready for new tests</div>
            `;
        }
    </script>
</body>
</html>
